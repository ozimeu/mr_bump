#!/usr/bin/env ruby
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Small script to tag releases and update changelogs
require 'mr_bump'
require 'mr_bump/git_api'

release = !MrBump.current_branch[/^release/].nil?
master = !MrBump.current_branch[/^master$/].nil?
repo_path = MrBump.git_config.path

unless release || master
  puts 'Need to be on either release or master branch'
  exit 1
end

unless master || MrBump.current_branch.to_s == "release/#{MrBump.current_uat_major}"
  puts "On release branch '#{MrBump.current_branch}'. " \
       "Expected release branch 'release/#{MrBump.current_uat_major}'"
  exit 1
end

puts 'Here are the 10 most recent open PRs in your repo:'
puts MrBump::GitApi.sorted_prs(repo_path)
pr_id = ""
while pr_id !~ /\d+/
  print 'Enter your PR ID number : '
  pr_id = gets.chomp
  if pr_id !~ /\d+/
    puts 'PR ID must only contain numbers'
  end
end
merged = MrBump::GitApi.is_merged?(repo_path, pr_id)

if merged
  puts 'PR is already closed. . .'
else
  puts "PR is not merged, attempting to merge PR #{pr_id}. . ."
  MrBump::GitApi.merge_pr(repo_path, pr_id)
end

unless system('git remote update > /dev/null 2>&1')
  puts 'Failed to update remotes. (Connectivity problems?)'
  exit 1
end

unless `git rev-parse @` == `git rev-parse @{u}`
  puts 'Not up to date with origin! Please run git pull'
  puts "Would you like to run 'git pull' now?"
  loop do
    print "[Y]es / [N]o : "
    choice = gets.chomp.upcase

    case choice
    when 'Y'
      system("git pull --ff-only")
    when 'N'
      exit 1
    else
      puts "I'm sorry Dave; I'm afraid I can't do that."
    end
  end
end

unless File.file?('CHANGELOG.md')
  puts "Couldn't find CHANGELOG.md. ensure you are in the root of the git checkout"
  exit 1
end

if release
  last_release = MrBump.current_uat
  current_uat_major = MrBump.current_uat_major
  changes = MrBump.change_log_items_for_range(last_release, "release/#{current_uat_major}")
else
  last_release = MrBump.current_master
  changes = MrBump.change_log_items_for_range(last_release, 'master')
end

new_release = last_release.bump_patch
changes = changes.join('')
md_changes = "# #{new_release}#{changes}\n\n"

puts 'Changelog additions'
puts '----------'
puts md_changes
puts '----------'

loop do
  print '[A]ccept these changes / Manually [E]dit / [C]ancel Release : '
  choice = gets.chomp.upcase

  case choice
  when 'A'
    MrBump.file_prepend('CHANGELOG.md', md_changes)
    break
  when 'E'
    MrBump.file_prepend('CHANGELOG.md', md_changes)
    system 'nano CHANGELOG.md'
    loop do
      log = File.open('CHANGELOG.md', 'r').read
      changes = log.split("\n\n").first.strip.split("\n").drop(1)
      changes = changes.join("\n")
      md_changes = "# #{new_release}\n#{changes}\n\n"
      puts 'Modified Changelog additions'
      puts '----------'
      puts md_changes
      puts '----------'
      print '[A]ccept modified changes / [C]ancel Release : '
      choice2 = gets.chomp.upcase
      if choice2 == 'C'
        exit 1
      elsif choice2 == 'A'
        break
      else
        puts "I'm sorry Dave; I'm afraid I can't do that."
      end
    end
    break
  when 'C'
    exit 1
  else
    puts "I'm sorry Dave; I'm afraid I can't do that."
  end
end

`git commit -m 'Bump version to #{new_release}' CHANGELOG.md`
`git tag #{new_release}`
`git push && git push --tags`

MrBump.slack_notifier(new_release, changes)

config_file = MrBump.config_file()
branch_type = release ? "release" : 'master'
bump_cmd_exists = config_file.key?('post_bump') &&
                  config_file['post_bump'].key?(branch_type)
if bump_cmd_exists
  loop do
    puts 'Would you like to execute post bump commands? '
    print '[Y]es execute / [N]o Im done : '
    choice = gets.chomp.upcase

    case choice
    when 'Y'
      post_command = config_file['post_bump'][branch_type]
      system post_command
      break
    when 'N'
      break
    else
      puts "I'm sorry Dave; I'm afraid I can't do that."
    end
  end
end
